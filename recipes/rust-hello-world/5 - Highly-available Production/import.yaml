project:
  name: rust-hello-world-highly-available-production
  # Serious core: dedicated physical cores reserved for this project.
  # Eliminates noisy-neighbour CPU contention at the hypervisor level.
  # Required for predictable latency on high-traffic production workloads.
  # Docs: https://docs.zerops.io/features/infrastructure#project-core-options
  corePackage: SERIOUS

services:
  # HA production app: dedicated CPU cores for consistent low latency.
  # Rust's predictable, allocation-free runtime makes it an excellent fit
  # for dedicated CPU environments — no GC pauses, no JIT warmup, no
  # unpredictable memory growth between requests.
  # Two minimum containers ensure zero-downtime deploys; autoscaling adds
  # more as traffic grows.
  - hostname: app
    type: rust@stable
    zeropsSetup: prod
    buildFromGit: https://github.com/zerops-recipe-apps/rust-hello-world-app
    enableSubdomainAccess: true
    minContainers: 2
    maxContainers: 10
    # DEDICATED mode pins vCPUs to this container — no sharing with other
    # tenants. Enables consistent sub-millisecond response times under load.
    cpuMode: DEDICATED
    resources:
      minRam: 0.5
      # Reserve ~30% as free RAM. Even without GC, Rust allocators hold
      # memory pages between requests; headroom prevents OOM kills at peak.
      minFreeRamGB: 0.25
      minVCpu: 2

  # HA PostgreSQL: primary + replica with automatic failover.
  # If the primary fails, Zerops promotes the replica and updates the
  # db_hostname connection variable automatically — no DNS changes needed.
  # Dedicated CPU prevents database latency spikes from competing workloads.
  # Priority 10 ensures the database cluster is healthy before app containers
  # start, preventing connection errors during initial deployment.
  - hostname: db
    type: postgresql@17
    mode: HA
    priority: 10
    cpuMode: DEDICATED
    resources:
      minRam: 1
      minVCpu: 2
